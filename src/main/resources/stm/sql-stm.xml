<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stm">

    <resultMap id="ReceiptResultMap" type="Receipt">

        <id column="DEPOT_ID" jdbcType="CHAR" property="depotId" />
        <id column="RECEIPT_NO" jdbcType="CHAR" property="receiptNo" />
        <result column="TYPE" jdbcType="CHAR" property="type" />
        <result column="STATUS" jdbcType="CHAR" property="status" />
        <result column="REGISTRANT" jdbcType="CHAR" property="registrant" />
        <result column="AUDITOR" jdbcType="CHAR" property="auditor" />
        <result column="SUPPLIER" jdbcType="VARCHAR" property="supplier" />
        <result column="WRITE_DATE" jdbcType="TIMESTAMP" property="writeDate" />
        <result column="CONFIRM_DATE" jdbcType="TIMESTAMP" property="confirmDate" />
        <result column="REMARK" jdbcType="VARCHAR" property="remark" />
    </resultMap>
    
    <sql id="ReceiptColumn">
        DEPOT_ID, RECEIPT_NO, TYPE, STATUS, REGISTRANT, AUDITOR, 
        SUPPLIER, WRITE_DATE, CONFIRM_DATE, REMARK
    </sql>
    
    <sql id="ReceiptWhere">
        <where>
            <if test="depotId != null and depotId != ''">
	            DEPOT_ID = #{depotId,jdbcType=CHAR}
	        </if>
	        <if test="receiptNo != null and receiptNo != ''">
	            AND RECEIPT_NO = #{receiptNo,jdbcType=CHAR}
	        </if>
	        <if test="type != null and type != ''">
	            AND TYPE = #{type,jdbcType=CHAR}
	        </if>
	        <if test="startDate != null and startDate != ''">
	            AND DATE_FORMAT(WRITE_DATE,'%Y-%m-%d') &gt;= #{startDate,jdbcType=TIMESTAMP}
	        </if>
	        <if test="endDate != null and endDate != ''">
	            AND DATE_FORMAT(WRITE_DATE,'%Y-%m-%d') &lt;= #{endDate,jdbcType=TIMESTAMP}
	        </if>
	        <if test="status != null and status != ''">
	            AND STATUS = #{status,jdbcType=CHAR}
	        </if>
        </where> 
    </sql>
    
    <select id="selectMulReceipt" parameterType="map" resultMap="ReceiptResultMap">
        SELECT 
          <include refid="ReceiptColumn" />
        FROM TB_RECEIPT
        <include refid="ReceiptWhere" />
    </select>
    
    <select id="selectOneReceipt" parameterType="map" resultMap="ReceiptResultMap">
        SELECT 
          <include refid="ReceiptColumn" />
        FROM TB_RECEIPT
        <include refid="ReceiptWhere" />
    </select>
    
    <select id="selectReceiptPageData" resultMap="ReceiptResultMap">
        <include refid="page.pageSelectList" />
        SELECT 
          <include refid="ReceiptColumn" />
        FROM TB_RECEIPT
        <include refid="ReceiptWhere" />
        <include refid="page.pageWhereList" />
    </select>
    
    <select id="selectReceiptPageCnt" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM TB_RECEIPT
        <include refid="ReceiptWhere" />
    </select>
    
    <update id="updateOneReceipt" parameterType="map" >
        UPDATE TB_RECEIPT
        <set >
            <if test="type != null" >
                type = #{type,jdbcType=CHAR},
            </if>
            <if test="status != null" >
                status = #{status,jdbcType=CHAR},
            </if>
            <if test="registrant != null" >
                registrant = #{registrant,jdbcType=CHAR},
            </if>
            <if test="auditor != null" >
                auditor = #{auditor,jdbcType=CHAR},
            </if>
            <if test="supplier != null" >
                supplier = #{supplier,jdbcType=VARCHAR},
            </if>
            <if test="writeDate != null" >
                write_date = #{writeDate,jdbcType=TIMESTAMP},
            </if>
            <if test="confirmDate != null" >
                confirm_date = #{confirmDate,jdbcType=TIMESTAMP},
            </if>
            <if test="remark != null" >
                remark = #{remark,jdbcType=VARCHAR},
            </if>
        </set>
        WHERE DEPOT_ID = #{depotId,jdbcType=CHAR}
        AND RECEIPT_NO = #{receiptNo,jdbcType=CHAR}
    </update>
    
    <delete id="deleteOneReceipt" parameterType="map" >
        DELETE FROM TB_RECEIPT
        WHERE DEPOT_ID = #{depotId,jdbcType=CHAR}
         AND RECEIPT_NO = #{receiptNo,jdbcType=CHAR}
    </delete>
    
    <resultMap id="ReceiptDetailResultMap" type="ReceiptDetail">
        <id column="DEPOT_ID" jdbcType="CHAR" property="depotId" />
        <id column="RECEIPT_NO" jdbcType="CHAR" property="receiptNo" />
        <id column="COMMODITY_TYPE" jdbcType="CHAR" property="commodityType" />
        <result column="UNIT_PRICE" jdbcType="DECIMAL" property="unitPrice" />
        <result column="QUANTITY" jdbcType="REAL" property="quantity" />
        <result column="AMOUNT" jdbcType="DECIMAL" property="amount" />
        <result column="TAX_RATE" jdbcType="DECIMAL" property="taxRate" />
        <result column="TAX_AMT" jdbcType="DECIMAL" property="taxAmt" />
        <result column="NORM" jdbcType="CHAR" property="norm" />
        <result column="BRAND" jdbcType="CHAR" property="brand" />
        <result column="GROUP_ID" property="groupId" jdbcType="CHAR" />
        <result column="TYPE_ID" property="typeId" jdbcType="CHAR" />
        <association property="productType" column="groupId=GROUP_ID,typeId=TYPE_ID}"  select="common.selectOneProductType"/>
    </resultMap>
    
    <sql id="ReceiptDetailColumn">
        DEPOT_ID, RECEIPT_NO, COMMODITY_TYPE, UNIT_PRICE, QUANTITY, AMOUNT, TAX_RATE, TAX_AMT, 
        NORM ,BRAND, SUBSTR(COMMODITY_TYPE,1,2) AS GROUP_ID ,SUBSTR(COMMODITY_TYPE,3,3) AS TYPE_ID
    </sql>
    
    <sql id="ReceiptDetailWhere">
        <where>
            <if test="depotId != null and depotId != ''">
	            DEPOT_ID = #{depotId,jdbcType=CHAR}
	        </if>
	        <if test="receiptNo != null and receiptNo != ''">
	            AND RECEIPT_NO = #{receiptNo,jdbcType=CHAR}
	        </if>
	        <if test="commodityType != null and commodityType != ''">
	            AND COMMODITY_TYPE = #{commodityType,jdbcType=CHAR}
	        </if>
        </where> 
    </sql>
    
    <select id="selectMulReceiptDetail" parameterType="map" resultMap="ReceiptDetailResultMap">
        SELECT 
          <include refid="ReceiptDetailColumn" />
        FROM TB_RECEIPT_DETAIL
        <include refid="ReceiptDetailWhere" />
    </select>
    
    
    <resultMap id="InventoryResultMap" type="Inventory" >
        <id column="DEPOT_ID" property="depotId" jdbcType="CHAR" />
        <id column="COMMODITY_TYPE" property="commodityType" jdbcType="CHAR" />
        <result column="AVERAGE_PRICE" property="averagePrice" jdbcType="DECIMAL" />
        <result column="QUANTITY" property="quantity" jdbcType="REAL" />
        <result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
        <result column="TAX_AMT" property="taxAmt" jdbcType="DECIMAL" />
        <result column="AVERAGE_TAX_RATE" property="averageTaxRate" jdbcType="DECIMAL" />
    </resultMap>
    
    <sql id="InventoryColumn" >
        DEPOT_ID, COMMODITY_TYPE, AVERAGE_PRICE, QUANTITY, AMOUNT, TAX_AMT, AVERAGE_TAX_RATE
    </sql>
    
    <select id="selectOneInventory" parameterType="map" resultMap="InventoryResultMap">
        SELECT
            <include refid="InventoryColumn" />
        FROM TB_INVENTORY
        WHERE DEPOT_ID = #{depotId,jdbcType=CHAR}
          AND COMMODITY_TYPE = #{commodityType,jdbcType=CHAR}
    </select>
    
    <insert id="insertUpdateOneInventory" parameterType="Inventory">
        INSERT INTO TB_INVENTORY (<include refid="InventoryColumn" />)
        VALUES(
        #{depotId,jdbcType=CHAR}, 
        #{commodityType,jdbcType=CHAR}, 
        #{averagePrice,jdbcType=DECIMAL}, 
        #{quantity,jdbcType=REAL}, 
        #{amount,jdbcType=DECIMAL}, 
        #{taxAmt,jdbcType=DECIMAL}, 
        #{averageTaxRate,jdbcType=DECIMAL})
        ON DUPLICATE KEY UPDATE
        AVERAGE_PRICE = #{averagePrice,jdbcType=DECIMAL},
        QUANTITY = #{quantity,jdbcType=REAL},
        AMOUNT = #{amount,jdbcType=DECIMAL},
        TAX_AMT = #{taxAmt,jdbcType=DECIMAL},
        AVERAGE_TAX_RATE = #{averageTaxRate,jdbcType=DECIMAL}
    </insert>
    
</mapper>